  <!DOCTYPE html>
<html lang = "en-US">

<head>

  	<meta charset = "UTF-8">
  	<link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  	<!-- Bootstrap -->
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  	<!-- Datatables -->
  	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
  	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>
  	<!-- Title -->
  	<title>Mon Parc d'Eclairage</title>
  	<!-- Custom styles -->
  	<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='style/style.css') }}">
    <!-- Leaflet -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src='static/Chart.min.js'></script>
    <!-- Hightchart (Zoomable Timeseries) -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>

</head>

<body>

		<nav class="navbar navbar-inverse navbar-fixed-top navbar-light bg-light" role="navigation">
			<a class="navbar-brand" href="/getEvents">Mon Parc</a>
      <a class="navbar-brand" href="/admin">Alertes</a>
      <a class="navbar-brand" href="/newDevice">Gérer mes équipements</a>
      <a href="/signIn"><img src="/static/images/logout.png" title="Déconnexion" style="margin-left: 75%; margin-top: 5px; height: 40px; width: 40px;"></img></a>
			<div class="collapse navbar-collapse" id="navbarSupportedContent"></div>
		</nav>

		<br>
		<br>
		<br>
		<br>

		<div>
			<h1>Mon Parc</h1>
		</div>

    <div style= "background-color: white; padding: 0px; border-radius: 10px; border: 1px solid grey; margin-top: 0px; margin-bottom: 30px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
      <div id="map" style="height: 650px; border-radius: 10px;"></div>
    </div>

    <div style= "background-color: white; padding: 15px; border-radius: 10px; border: 1px solid grey; margin-top: 0px; margin-bottom: 30px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
      <div id="container" style="min-width: 310px; height: 600px; margin: 0 auto"></div>
    </div>

    <div style= "background-color: white; padding: 15px; border-radius: 10px; border: 1px solid grey; margin-top: 0px; margin-bottom: 30px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
      <h1 style="font-size: 25px; text-align: center;">Focus semaine du {{ week_monday_date }}</h1>
      <form action="{{ url_for('getEvents') }}" method="post" class="form-inline" role="form" style="text-align: center; padding-top: 10px;">
        <div class="form-group">
  				<d1>
            <input type="week" required class="form-control" id="week" name="week" value="{{ week }}" style="width: 200px;">
            <input type="hidden" name="action" value="per_week">
  				</d1>
  			</div>
        <div class="form-group">
  				<d1>
            <input id="filter" type=submit value="Visualiser" class="btn btn-success">
  				</d1>
  			</div>
  		</form>

      <canvas id="weekChart" style="padding: 10px;"></canvas>

    </div>

</body>

<script>

  //LEAFLET

  var map = L.map('map').setView(
    {% if OffDevices != [] %}
        [{{OffDevices.latitude}},{{OffDevices.longitude}}], 18);
    {% else %}
      [48.8126508,2.3881197], 15);
    {% endif %}
  var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
  });

  var redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',

      iconSize:     [25, 41],
      shadowSize:   [41, 41],
      iconAnchor:   [12, 41],
      shadowAnchor: [4, 62],
      popupAnchor:  [0, -50]
  });

  var orangeIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',

      iconSize:     [25, 41],
      shadowSize:   [41, 41],
      iconAnchor:   [12, 41],
      shadowAnchor: [4, 62],
      popupAnchor:  [0, -50]
  });

  var greenIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',

      iconSize:     [25, 41],
      shadowSize:   [41, 41],
      iconAnchor:   [12, 41],
      shadowAnchor: [4, 62],
      popupAnchor:  [0, -50]
  });

  {% for device in devices %}

    {% if device.status == 0 %}
      L.marker([{{device.latitude}},{{device.longitude}}], {icon: redIcon}).on('click', function() {
        centerLeafletMapOnMarker(map, this);
      }).addTo(map)
      .bindPopup("<b> Device {{device.device}} </b>  </br> Défectueux </br> ---------------- </br> Rue {{device.street}} </br> {{device.latitude}}, {{device.longitude}}").openPopup();

    {% elif device.status == 0.5 %}
      L.marker([{{device.latitude}},{{device.longitude}}], {icon: orangeIcon}).on('click', function() {
      centerLeafletMapOnMarker(map, this);
    }).addTo(map)
      .bindPopup("<b> Device {{device.device}} </b>  </br> À Surveiller </br> ---------------- </br> Rue {{device.street}} </br> {{device.latitude}}, {{device.longitude}}");

    {% else %}
      L.marker([{{device.latitude}},{{device.longitude}}], {icon: greenIcon}).on('click', function() {
      centerLeafletMapOnMarker(map, this);
    }).addTo(map)
      .bindPopup("<b> Device {{device.device}} </b> </br> Fonctionnel </br> ---------------- </br> Rue {{device.street}} </br> {{device.latitude}}, {{device.longitude}}");

    {% endif %}

  {% endfor %}

  var legend = L.control({position: 'bottomleft'});

  legend.onAdd = function (map) {

      var div = L.DomUtil.create('div', 'info legend'),
          grades = ["Fonctionnel", "À Surveiller", "Défectueux"],
          labels = ["https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png","https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png", "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png"];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < grades.length; i++) {
          div.innerHTML +=
               (" <img src="+ labels[i] +" height='41' width='25' style='margin-bottom:5px; margin-right:5px'>") + grades[i] +'<br>';
      }

      return div;
  };

  legend.addTo(map);

  function centerLeafletMapOnMarker(map, marker) {
    var latLngs = [ marker.getLatLng() ];
    var markerBounds = L.latLngBounds(latLngs);
    map.fitBounds(markerBounds);
  }

  map.addLayer(layer);

  //ChartJS

  // get chart canvas
  var ctx = document.getElementById("weekChart").getContext("2d");

  var green_gradient = ctx.createLinearGradient(0, 0, 0, 950);
  green_gradient.addColorStop(0.9, 'rgba(92,184,92,1)');
  green_gradient.addColorStop(0.5, 'rgba(92,184,92,0.7)');
  green_gradient.addColorStop(1, 'rgba(92,184,92,0.3)');

  var blue_gradient = ctx.createLinearGradient(0, 0, 0, 850);
  blue_gradient.addColorStop(0.9, 'rgba(75,192,192,1)');
  blue_gradient.addColorStop(0.5, 'rgba(75,192,192,.7)');
  blue_gradient.addColorStop(1, 'rgba(75,192,192,0.3)');

  var red_gradient = ctx.createLinearGradient(0, 0, 0, 850);
  red_gradient.addColorStop(0.9, 'rgba(255, 51, 51, 1)');
  red_gradient.addColorStop(0.3, 'rgba(255, 51, 51, .7)');
  red_gradient.addColorStop(1, 'rgba(255, 51, 51, 0.3)');

  //weekChart

  var week_chartData = {
    labels : ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'],
    datasets : [{
        label: 'Rue Lénine',
        fill: false,
        lineTension: .3,
        backgroundColor: blue_gradient,
        borderColor: "rgba(75,192,192,0.4)",
        borderWidth: 0,
        borderCapStyle: 'butt',
        borderDash: [],
        borderDashOffset: 0.0,
        borderJoinStyle: 'miter',
        pointBorderColor: "rgba(75,192,192,1)",
        pointBackgroundColor: "#fff",
        pointBorderWidth: 1,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: "rgba(75,192,192,1)",
        pointHoverBorderColor: "rgba(220,220,220,1)",
        pointHoverBorderWidth: 2,
        pointRadius: 1,
        pointHitRadius: 10,
        data : [{% for item in Lenine_week_values %}
                  {{item}},
                {% endfor %}],
        spanGaps: false
    },
    {
        label: 'Rue Maurice Grandcoing',
        fill: false,
        lineTension: .3,
        backgroundColor: red_gradient,
        borderColor: "#ff3333",
        borderWidth: 0,
        borderCapStyle: 'butt',
        borderDash: [],
        borderDashOffset: 0.0,
        borderJoinStyle: 'miter',
        pointBorderColor: "rgba(75,192,192,1)",
        pointBackgroundColor: "#fff",
        pointBorderWidth: 1,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: "rgba(75,192,192,1)",
        pointHoverBorderColor: "rgba(220,220,220,1)",
        pointHoverBorderWidth: 2,
        pointRadius: 1,
        pointHitRadius: 10,
        data : [{% for item in MG_week_values %}
                  {{item}},
                {% endfor %}],
        spanGaps: false
    },
    {
        label: 'Rue Toto',
        fill: false,
        lineTension: .3,
        backgroundColor: green_gradient,
        borderColor: "#5cb85c",
        borderWidth: 0,
        borderCapStyle: 'butt',
        borderDash: [],
        borderDashOffset: 0.0,
        borderJoinStyle: 'miter',
        pointBorderColor: "rgba(75,192,192,1)",
        pointBackgroundColor: "#fff",
        pointBorderWidth: 1,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: "rgba(75,192,192,1)",
        pointHoverBorderColor: "rgba(220,220,220,1)",
        pointHoverBorderWidth: 2,
        pointRadius: 1,
        pointHitRadius: 10,
        data : [{% for item in Toto_week_values %}
                  {{item}},
                {% endfor %}],
        spanGaps: false
    }]
  }

  // create the chart using the chart canvas
  var weekChart = new Chart(ctx, {
    type: 'bar',
    data: week_chartData,
    options: {
        legend: {
            labels: {
                padding: 20
            }
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }],
            xAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        },
        responsive: true
      },
  });

  //HighCharts, zoomable timeseries
  $( document ).ready(function() {

      Highcharts.chart('container', {
          chart: {
              zoomType: 'x'
          },
          colors: ['#CB2940', '#5cb85c', '#6699ff'],
          title: {
              text: 'Mes Données par Rue'
          },
          subtitle: {
              text: document.ontouchstart === undefined ?
                      'Cliquer-glisser pour zoomer' : 'Pincer avec deux doigts pour zoomer'
          },
          xAxis: {
              type: 'datetime'
          },
          yAxis: {
              title: {
                  text: 'Evènements'
              },
              min: 0
          },
          legend: {
              enabled: true
          },
          plotOptions: {
              spline: {
                  fillColor: {
                      linearGradient: {
                          x1: 0,
                          y1: 0,
                          x2: 0,
                          y2: 1
                      },
                      stops: [
                      ]
                  },
                  marker: {
                      radius: 2
                  },
                  lineWidth: 1,
                  states: {
                      hover: {
                          lineWidth: 1
                      }
                  },
                  threshold: null
              }
          },

          series: [
          {% for set in data %}
            {
                type: 'spline',
                name: '{{ set[0] }}',
                data: {{ set[1] }}
            },
          {% endfor %}
          ]
      });
  });
</script>
